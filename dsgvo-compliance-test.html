<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSGVO Cookie Banner - Compliance Test Suite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            min-height: 100vh;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .test-section {
            background: white;
            padding: 2rem;
            margin: 2rem 0;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #667eea;
        }

        .test-section h2 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.8rem;
        }

        .test-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .test-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }

        .test-btn.danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .test-btn.success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        }

        .test-btn.info {
            background: linear-gradient(135deg, #339af0 0%, #228be6 100%);
        }

        .status-panel {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .status-panel h3 {
            color: #495057;
            margin-bottom: 1rem;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-indicator {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-ok {
            background: #d3f9d8;
            color: #2b8a3e;
        }

        .status-error {
            background: #ffe0e6;
            color: #c92a2a;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .content-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: #fafafa;
            border-radius: 8px;
        }

        .content-section h3 {
            color: #333;
            margin-bottom: 1rem;
        }

        .content-section p {
            margin-bottom: 1rem;
            color: #666;
        }

        .cookie-status {
            background: #f1f3f4;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .compliance-checklist {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .compliance-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .compliance-item:last-child {
            border-bottom: none;
        }

        .compliance-check {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .compliance-check.pass {
            background: #28a745;
        }

        .compliance-check.fail {
            background: #dc3545;
        }

        .compliance-check.pending {
            background: #ffc107;
            color: #212529;
        }

        .dsgvo-article {
            font-size: 0.8rem;
            color: #6c757d;
            font-style: italic;
        }

        .test-results {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }

        .alert-success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        #cookieStatus {
            white-space: pre-wrap;
            font-size: 0.85rem;
        }

        .footer {
            margin-top: 3rem;
            padding: 2rem;
            background: #343a40;
            color: white;
            border-radius: 8px;
            text-align: center;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 2rem;
            }

            .test-buttons {
                grid-template-columns: 1fr;
            }

            .test-section {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üç™ DSGVO Cookie Banner</h1>
            <div class="subtitle">Compliance Test Suite & Integration Demo</div>
        </header>

        <div class="alert alert-info">
            <strong>üìã Test-Anleitung:</strong> Diese Seite testet alle DSGVO-Compliance-Features des Cookie-Banners. 
            Nutzen Sie die Test-Buttons systematisch und beobachten Sie das Banner-Verhalten. 
            Der Compliance-Status wird automatisch aktualisiert.
        </div>

        <!-- Banner-Funktionalit√§ts-Tests -->
        <div class="test-section">
            <h2>üéØ Banner-Funktionalit√§ts-Tests</h2>
            <p>Grundlegende Banner-Funktionen und erste Interaktion</p>
            
            <div class="test-buttons">
                <button class="test-btn" onclick="testBannerVisibility()">Banner-Sichtbarkeit pr√ºfen</button>
                <button class="test-btn success" onclick="acceptAllCookies()">Alle Cookies akzeptieren</button>
                <button class="test-btn danger" onclick="rejectAllCookies()">Alle Cookies ablehnen</button>
                <button class="test-btn info" onclick="openBanner()">Banner erneut √∂ffnen</button>
            </div>
        </div>

        <!-- DSGVO-Compliance-Tests -->
        <div class="test-section">
            <h2>‚öñÔ∏è DSGVO-Compliance-Tests</h2>
            <p>Rechtliche Anforderungen und Widerrufsmechanismen</p>
            
            <div class="test-buttons">
                <button class="test-btn info" onclick="showDetails()">Details-Modal √∂ffnen</button>
                <button class="test-btn danger" onclick="withdrawConsent()">Einwilligung widerrufen</button>
                <button class="test-btn" onclick="testGranularConsent()">Granulare Auswahl testen</button>
                <button class="test-btn" onclick="checkEqualVisibility()">Gleichwertigkeit pr√ºfen</button>
            </div>
        </div>

        <!-- Cookie-Status-Monitor -->
        <div class="test-section">
            <h2>üîç Cookie-Status-Monitor</h2>
            <div class="test-buttons">
                <button class="test-btn info" onclick="updateCookieStatus()">Status aktualisieren</button>
                <button class="test-btn danger" onclick="clearAllData()">Alle Daten l√∂schen</button>
                <button class="test-btn" onclick="simulateNewVisitor()">Neuer Besucher simulieren</button>
            </div>
            
            <div class="cookie-status" id="cookieStatus">
                Cookie-Status wird hier angezeigt...
            </div>
        </div>

        <!-- DSGVO-Compliance-Checklist -->
        <div class="test-section">
            <h2>‚úÖ DSGVO-Compliance-Checklist</h2>
            <div class="compliance-checklist" id="complianceChecklist">
                <div class="compliance-item">
                    <div class="compliance-check pending" id="check-banner-display">?</div>
                    <div>
                        <strong>Banner erscheint bei erstem Besuch</strong><br>
                        <span class="dsgvo-article">Art. 7 DSGVO - Vor Cookie-Setzung</span>
                    </div>
                </div>
                <div class="compliance-item">
                    <div class="compliance-check pending" id="check-equal-buttons">?</div>
                    <div>
                        <strong>Akzeptieren/Ablehnen gleichwertig dargestellt</strong><br>
                        <span class="dsgvo-article">Keine "Dark Patterns" erlaubt</span>
                    </div>
                </div>
                <div class="compliance-item">
                    <div class="compliance-check pending" id="check-granular-choice">?</div>
                    <div>
                        <strong>Granulare Auswahl m√∂glich</strong><br>
                        <span class="dsgvo-article">Art. 7 DSGVO - Spezifische Einwilligung</span>
                    </div>
                </div>
                <div class="compliance-item">
                    <div class="compliance-check pending" id="check-withdrawal">?</div>
                    <div>
                        <strong>Widerruf so einfach wie Erteilung</strong><br>
                        <span class="dsgvo-article">Art. 7 Abs. 3 DSGVO - Widerrufsrecht</span>
                    </div>
                </div>
                <div class="compliance-item">
                    <div class="compliance-check pending" id="check-information">?</div>
                    <div>
                        <strong>Vollst√§ndige Informationen bereitgestellt</strong><br>
                        <span class="dsgvo-article">Art. 13/14 DSGVO - Informationspflichten</span>
                    </div>
                </div>
                <div class="compliance-item">
                    <div class="compliance-check pending" id="check-cookie-deletion">?</div>
                    <div>
                        <strong>Cookies werden bei Ablehnung/Widerruf gel√∂scht</strong><br>
                        <span class="dsgvo-article">Art. 17 DSGVO - Recht auf L√∂schung</span>
                    </div>
                </div>
                <div class="compliance-item">
                    <div class="compliance-check pending" id="check-third-country">?</div>
                    <div>
                        <strong>Drittland-Transfer-Hinweise angezeigt</strong><br>
                        <span class="dsgvo-article">Art. 44-49 DSGVO - Drittlandtransfer</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test-Content f√ºr realistische Website -->
        <div class="content-section">
            <h3>üåê Test-Website-Content</h3>
            <p>Diese Sektion simuliert eine normale Website mit verschiedenen Inhalten, um das Banner-Verhalten in einer realistischen Umgebung zu testen.</p>
            
            <h4>√úber unser Unternehmen</h4>
            <p>Wir sind ein innovatives Technologieunternehmen, das sich auf datenschutzkonforme Web-L√∂sungen spezialisiert hat. Unsere Mission ist es, Websites DSGVO-konform zu gestalten, ohne die Benutzerfreundlichkeit zu beeintr√§chtigen.</p>
            
            <h4>Unsere Services</h4>
            <p>Von Cookie-Banner-L√∂sungen bis hin zu vollst√§ndigen Datenschutz-Audits - wir bieten umfassende DSGVO-Compliance-Services f√ºr Unternehmen jeder Gr√∂√üe.</p>
            
            <h4>Kontakt</h4>
            <p>Haben Sie Fragen zu unserem Cookie-Banner? Kontaktieren Sie uns gerne √ºber unser Kontaktformular oder per E-Mail.</p>
        </div>

        <!-- Test-Ergebnisse -->
        <div class="test-results">
            <h3>üìä Test-Ergebnisse</h3>
            <div id="testResults">
                <p>F√ºhren Sie Tests durch, um Ergebnisse zu sehen...</p>
            </div>
        </div>

        <div class="footer">
            <p>üîí DSGVO Cookie Banner System - Test Suite<br>
            Entwickelt f√ºr vollst√§ndige GDPR/DSGVO-Compliance</p>
        </div>
    </div>

    <!-- Cookie Banner Integration - ORIGINAL load.js Script -->
    <script>
        // Da das load.js √ºber Nginx ausgeliefert wird und wir keinen direkten Zugriff haben,
        // laden wir die Banner-Konfiguration und erstellen eine Test-Version die dem Original entspricht
        
        // Aber ZUERST erweitern wir die Test-Funktionen um das originale Banner zu unterst√ºtzen
        window.originalDsgvoBannerTest = true;
        
        // Lade das echte load.js Script dynamically 
        const script = document.createElement('script');
        script.src = 'project/public/load.js?id=2';  // Relativer Pfad zum originalen Script
        script.onerror = function() {
            console.warn('Original load.js nicht gefunden, lade fallback...');
            // Fallback: API direkt laden
            loadBannerConfig();
        };
        script.onload = function() {
            console.log('‚úÖ Original load.js geladen');
        };
        document.head.appendChild(script);
        
        function loadBannerConfig() {
            fetch('http://localhost:3001/api/config?id=2')
                .then(response => response.json()) 
                .then(data => {
                    console.log('‚úÖ Banner-Konfiguration geladen:', data);
                    // Falls das originale Script nicht l√§dt, verwende minimale Implementation
                    if (!window.dsgvoBanner) {
                        console.log('üîÑ Erstelle Fallback-Banner (Original-Stil)');
                        createOriginalStyleBanner(data);
                        setupTestAPI(data);
                    }
                })
                .catch(error => {
                    console.error('‚ùå Fehler beim Laden der Banner-Konfiguration:', error);
                });
        }
        
        function createOriginalStyleBanner(config) {
            // Erstelle Banner im Original-Stil (basierend auf load.js)
            const banner = document.createElement('div');
            banner.id = 'dsgvo-banner-container';
            
            // Original Banner HTML Template (vereinfacht)
            banner.innerHTML = `
                <div class="dsgvo-banner" style="
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    background: rgba(0, 0, 0, 0.95);
                    color: white;
                    padding: 20px;
                    box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
                    z-index: 999999;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
                    font-size: 14px;
                    line-height: 1.5;
                ">
                    <div style="max-width: 1200px; margin: 0 auto;">
                        <div style="margin-bottom: 15px;">
                            <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600;">${config.project.banner_title}</h3>
                            <p style="margin: 0; opacity: 0.9; max-width: 800px;">${config.project.banner_text}</p>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
                            <button data-action="accept-all" style="
                                background: #28a745;
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: 600;
                                font-size: 14px;
                                transition: background-color 0.2s;
                            ">${config.project.accept_all_text}</button>
                            
                            <button data-action="reject-all" style="
                                background: #dc3545;
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: 600;
                                font-size: 14px;
                                transition: background-color 0.2s;
                            ">Alle ablehnen</button>
                            
                            <button data-action="show-details" style="
                                background: transparent;
                                color: white;
                                border: 2px solid white;
                                padding: 10px 22px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: 600;
                                font-size: 14px;
                                transition: all 0.2s;
                            ">Details anzeigen</button>
                            
                            <button data-action="necessary-only" style="
                                background: transparent;
                                color: white;
                                border: 1px solid rgba(255,255,255,0.5);
                                padding: 10px 22px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: 500;
                                font-size: 14px;
                                opacity: 0.8;
                                transition: all 0.2s;
                            ">${config.project.necessary_only_text}</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(banner);
            
            // Event Delegation f√ºr Button-Clicks (wie im Original)
            banner.addEventListener('click', function(e) {
                const action = e.target.getAttribute('data-action');
                if (action) {
                    handleBannerAction(action, config);
                }
            });
        }
        
        function handleBannerAction(action, config) {
            const banner = document.getElementById('dsgvo-banner-container');
            
            switch(action) {
                case 'accept-all':
                    console.log('‚úÖ Alle Cookies akzeptiert (Original-Handler)');
                    acceptAllCookies();
                    banner.style.display = 'none';
                    break;
                case 'reject-all':
                    console.log('‚ùå Alle Cookies abgelehnt (Original-Handler)');
                    rejectAllCookies();
                    banner.style.display = 'none';
                    break;
                case 'show-details':
                    showOriginalDetailsModal(config);
                    break;
                case 'necessary-only':
                    console.log('‚öñÔ∏è Nur notwendige Cookies (Original-Handler)');
                    acceptNecessaryOnly();
                    banner.style.display = 'none';
                    break;
            }
        }
        
        function showOriginalDetailsModal(config) {
            // Original-Style Details Modal (basierend auf dem echten load.js)
            const modal = document.createElement('div');
            modal.id = 'dsgvo-details-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.75);
                z-index: 1000000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;
            
            // Modal Content im Original-Stil
            let categoriesHtml = '';
            config.categories.forEach(category => {
                const services = config.services.filter(s => s.category_id === category.id);
                
                categoriesHtml += `
                    <div style="margin: 16px 0; padding: 16px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="margin: 0; font-size: 16px; color: #212529; font-weight: 600;">${category.name}</h4>
                            <label class="dsgvo-toggle" style="display: flex; align-items: center; cursor: ${category.required ? 'not-allowed' : 'pointer'};">
                                <input type="checkbox" 
                                       ${category.required ? 'checked disabled' : ''} 
                                       data-category-id="${category.id}"
                                       style="margin-right: 8px; transform: scale(1.1);">
                                <span style="font-size: 13px; color: #6c757d;">${category.required ? 'Erforderlich' : 'Optional'}</span>
                            </label>
                        </div>
                        <p style="margin: 0 0 12px 0; font-size: 14px; color: #495057; line-height: 1.4;">${category.description}</p>
                        
                        ${services.map(service => `
                            <details style="margin: 8px 0; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                                <summary style="padding: 12px; cursor: pointer; font-weight: 500; color: #495057; font-size: 14px;">
                                    ${service.name}
                                    <span style="font-size: 12px; color: #6c757d;">(${service.provider})</span>
                                    ${service.provider.includes('Google') || service.provider.includes('Meta') ? 
                                        '<span style="color: #dc3545; font-size: 11px; margin-left: 4px;">üá∫üá∏ US-Anbieter</span>' : ''}
                                </summary>
                                <div style="padding: 12px; border-top: 1px solid #dee2e6; font-size: 13px; color: #495057;">
                                    <p style="margin: 0 0 8px 0;"><strong>Zweck:</strong> ${service.purpose}</p>
                                    <p style="margin: 0 0 8px 0;"><strong>Anbieter:</strong> ${service.provider}</p>
                                    <p style="margin: 0 0 8px 0;"><strong>Speicherdauer:</strong> ${service.retention_period}</p>
                                    <p style="margin: 0 0 8px 0;"><strong>Cookies:</strong> <code style="background: #f8f9fa; padding: 2px 4px; border-radius: 3px;">${service.cookie_names}</code></p>
                                    <p style="margin: 0;"><a href="${service.privacy_policy_url}" target="_blank" rel="noopener" style="color: #007bff;">Datenschutzerkl√§rung</a></p>
                                </div>
                            </details>
                        `).join('')}
                    </div>
                `;
            });
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <div style="padding: 20px; border-bottom: 1px solid #dee2e6; background: #f8f9fa; border-radius: 12px 12px 0 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 style="margin: 0; color: #212529; font-size: 20px;">Cookie-Einstellungen</h2>
                            <button id="close-details" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d; padding: 0; width: 30px; height: 30px;">&times;</button>
                        </div>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div style="margin-bottom: 20px; padding: 16px; background: #e7f3ff; border: 1px solid #b8daff; border-radius: 8px;">
                            <h4 style="margin: 0 0 8px 0; color: #0056b3; font-size: 15px;">üõ°Ô∏è Ihre Datenschutzrechte</h4>
                            <p style="margin: 0; font-size: 13px; color: #495057; line-height: 1.5;">
                                Sie haben jederzeit das Recht auf Auskunft, Berichtigung, L√∂schung und Widerruf Ihrer Einwilligung. 
                                Der Widerruf ist so einfach wie die Erteilung der Einwilligung.
                            </p>
                        </div>
                        
                        ${categoriesHtml}
                        
                        ${config.services.some(s => s.provider.includes('Google') || s.provider.includes('Meta')) ? `
                        <div style="margin-top: 16px; padding: 16px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
                            <h4 style="margin: 0 0 8px 0; color: #856404; font-size: 14px;">‚ö†Ô∏è Hinweis zu Drittland-Transfers</h4>
                            <p style="margin: 0; font-size: 12px; color: #856404; line-height: 1.5;">
                                Einige Services √ºbertragen Daten in die USA (Drittland mit anderem Datenschutzniveau). 
                                Mit Ihrer Einwilligung stimmen Sie diesem Transfer zu.
                            </p>
                        </div>` : ''}
                    </div>
                    
                    <div style="padding: 20px; border-top: 1px solid #dee2e6; background: #f8f9fa; border-radius: 0 0 12px 12px;">
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button id="save-selection" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">Auswahl speichern</button>
                            <button id="accept-all-modal" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">Alle akzeptieren</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Modal Event Handlers
            modal.querySelector('#close-details').addEventListener('click', () => modal.remove());
            modal.querySelector('#accept-all-modal').addEventListener('click', () => {
                acceptAllCookies();
                modal.remove();
                document.getElementById('dsgvo-banner-container').style.display = 'none';
            });
            modal.querySelector('#save-selection').addEventListener('click', () => {
                saveGranularSelection();
                modal.remove();
                document.getElementById('dsgvo-banner-container').style.display = 'none';
            });
            
            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        function acceptAllCookies() {
            localStorage.setItem('dsgvo_consent', JSON.stringify({
                timestamp: new Date().toISOString(),
                accepted_all: true,
                categories: [5, 6, 7, 8],
                expires: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString()
            }));
            
            // Test-Cookies setzen
            document.cookie = '_ga=test-analytics; path=/';
            document.cookie = '_fbp=test-facebook; path=/';
            document.cookie = 'user_preferences=test-prefs; path=/';
            
            triggerConsentEvent('accept-all');
        }
        
        function rejectAllCookies() {
            localStorage.setItem('dsgvo_consent', JSON.stringify({
                timestamp: new Date().toISOString(),
                accepted_all: false,
                categories: [5], // Nur notwendige
                expires: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString()
            }));
            
            clearNonEssentialCookies();
            triggerConsentEvent('reject-all');
        }
        
        function acceptNecessaryOnly() {
            rejectAllCookies(); // Gleiche Logik
        }
        
        function saveGranularSelection() {
            const checkboxes = document.querySelectorAll('input[data-category-id]');
            const acceptedCategories = [5]; // Notwendige immer
            
            checkboxes.forEach(cb => {
                if (cb.checked && cb.dataset.categoryId !== '5') {
                    acceptedCategories.push(parseInt(cb.dataset.categoryId));
                }
            });
            
            localStorage.setItem('dsgvo_consent', JSON.stringify({
                timestamp: new Date().toISOString(),
                accepted_all: false,
                categories: acceptedCategories,
                expires: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString()
            }));
            
            // Selektive Cookie-Behandlung
            if (!acceptedCategories.includes(7)) clearCookiesByPattern(['_ga', '_gid']);
            if (!acceptedCategories.includes(8)) clearCookiesByPattern(['_fbp', '_fbc']);
            if (!acceptedCategories.includes(6)) clearCookiesByPattern(['user_preferences']);
            
            triggerConsentEvent('granular-selection');
        }
        
        function clearNonEssentialCookies() {
            const cookiesToDelete = ['_ga', '_fbp', 'user_preferences', '_gid', '_gat', '_fbc'];
            cookiesToDelete.forEach(name => {
                document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
            });
        }
        
        function clearCookiesByPattern(patterns) {
            patterns.forEach(pattern => {
                document.cookie = `${pattern}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
            });
        }
        
        function triggerConsentEvent(action) {
            window.dispatchEvent(new CustomEvent('dsgvo-consent-changed', {
                detail: { action, timestamp: new Date().toISOString() }
            }));
        }
        
        function setupTestAPI(config) {
            // Globale API (kompatibel mit Original)
            window.dsgvoBanner = {
                open: function() {
                    const banner = document.getElementById('dsgvo-banner-container');
                    if (banner) {
                        banner.style.display = 'block';
                    } else {
                        createOriginalStyleBanner(config);
                    }
                },
                showDetails: function() {
                    showOriginalDetailsModal(config);
                },
                acceptAllCookies: acceptAllCookies,
                rejectAllCookies: rejectAllCookies,
                withdrawConsent: function() {
                    if (confirm('Einwilligung widerrufen? Alle Cookies werden gel√∂scht.')) {
                        localStorage.removeItem('dsgvo_consent');
                        clearNonEssentialCookies();
                        this.open();
                        triggerConsentEvent('withdrawal');
                    }
                },
                getConsent: function() {
                    const consent = localStorage.getItem('dsgvo_consent');
                    return consent ? JSON.parse(consent) : null;
                }
            };
            
            console.log('üåê Original-Style DSGVO Banner API bereit');
            window.dispatchEvent(new CustomEvent('dsgvo-banner-loaded'));
        }
        
        // Initialisierung
        setTimeout(() => {
            loadBannerConfig();
        }, 100);
        
    </script>

    <script>
        // Global test state
        let testResults = {
            bannerDisplayed: false,
            granularChoiceAvailable: false,
            withdrawalTested: false,
            cookiesDeletionVerified: false,
            thirdCountryWarningsShown: false
        };

        // Test-Funktionen
        function testBannerVisibility() {
            const banner = document.querySelector('[id*="cookie"], [class*="cookie"], [id*="banner"], [class*="banner"]');
            const isVisible = banner && (banner.style.display !== 'none') && (banner.offsetHeight > 0);
            
            updateComplianceStatus('check-banner-display', isVisible);
            addTestResult(`Banner-Sichtbarkeit: ${isVisible ? '‚úÖ Sichtbar' : '‚ùå Nicht sichtbar'}`);
            testResults.bannerDisplayed = isVisible;
        }

        function acceptAllCookies() {
            if (window.dsgvoBanner && window.dsgvoBanner.acceptAllCookies) {
                window.dsgvoBanner.acceptAllCookies();
                addTestResult('‚úÖ Alle Cookies akzeptiert √ºber API');
                setTimeout(updateCookieStatus, 1000);
                updateComplianceStatus('check-equal-buttons', true);
            } else {
                addTestResult('‚ùå acceptAllCookies() Funktion nicht verf√ºgbar');
            }
        }

        function rejectAllCookies() {
            if (window.dsgvoBanner && window.dsgvoBanner.rejectAllCookies) {
                window.dsgvoBanner.rejectAllCookies();
                addTestResult('‚úÖ Alle Cookies abgelehnt √ºber API');
                setTimeout(() => {
                    updateCookieStatus();
                    checkCookieDeletion();
                }, 1000);
                updateComplianceStatus('check-equal-buttons', true);
            } else {
                addTestResult('‚ùå rejectAllCookies() Funktion nicht verf√ºgbar');
            }
        }

        function openBanner() {
            if (window.dsgvoBanner && window.dsgvoBanner.open) {
                window.dsgvoBanner.open();
                addTestResult('‚úÖ Banner erneut ge√∂ffnet');
                setTimeout(testBannerVisibility, 500);
            } else {
                addTestResult('‚ùå open() Funktion nicht verf√ºgbar');
            }
        }

        function showDetails() {
            if (window.dsgvoBanner && window.dsgvoBanner.showDetails) {
                window.dsgvoBanner.showDetails();
                addTestResult('‚úÖ Details-Modal ge√∂ffnet');
                setTimeout(() => {
                    testGranularOptions();
                    checkThirdCountryWarnings();
                    checkInformationCompleteness();
                }, 1000);
            } else {
                addTestResult('‚ùå showDetails() Funktion nicht verf√ºgbar');
            }
        }

        function withdrawConsent() {
            if (window.dsgvoBanner && window.dsgvoBanner.withdrawConsent) {
                window.dsgvoBanner.withdrawConsent();
                addTestResult('‚úÖ Einwilligung widerrufen');
                testResults.withdrawalTested = true;
                updateComplianceStatus('check-withdrawal', true);
                setTimeout(() => {
                    updateCookieStatus();
                    checkCookieDeletion();
                }, 1000);
            } else {
                addTestResult('‚ùå withdrawConsent() Funktion nicht verf√ºgbar');
                updateComplianceStatus('check-withdrawal', false);
            }
        }

        function testGranularConsent() {
            showDetails();
            setTimeout(testGranularOptions, 1000);
        }

        function testGranularOptions() {
            // Suche nach Toggle-Switches oder Checkboxen im Details-Modal
            const toggles = document.querySelectorAll('input[type="checkbox"], .toggle, .switch, [role="switch"]');
            const granularAvailable = toggles.length > 0;
            
            testResults.granularChoiceAvailable = granularAvailable;
            updateComplianceStatus('check-granular-choice', granularAvailable);
            addTestResult(`Granulare Auswahl: ${granularAvailable ? '‚úÖ Verf√ºgbar (' + toggles.length + ' Optionen)' : '‚ùå Nicht gefunden'}`);
        }

        function checkEqualVisibility() {
            // Pr√ºfe die Sichtbarkeit und Gestaltung der Haupt-Buttons
            const acceptBtn = document.querySelector('[class*="accept"], [id*="accept"]');
            const rejectBtn = document.querySelector('[class*="reject"], [class*="decline"], [id*="reject"]');
            
            let isEqual = false;
            if (acceptBtn && rejectBtn) {
                const acceptStyle = window.getComputedStyle(acceptBtn);
                const rejectStyle = window.getComputedStyle(rejectBtn);
                
                // Vereinfachte Gleichwertigkeitspr√ºfung
                const acceptSize = parseInt(acceptStyle.fontSize);
                const rejectSize = parseInt(rejectStyle.fontSize);
                const sizeEqual = Math.abs(acceptSize - rejectSize) <= 2;
                
                isEqual = sizeEqual && acceptStyle.display !== 'none' && rejectStyle.display !== 'none';
            }
            
            updateComplianceStatus('check-equal-buttons', isEqual);
            addTestResult(`Gleichwertige Button-Darstellung: ${isEqual ? '‚úÖ Erf√ºllt' : '‚ùå Nicht erf√ºllt'}`);
        }

        function checkThirdCountryWarnings() {
            // Suche nach Drittland-Hinweisen
            const content = document.body.innerText.toLowerCase();
            const hasUSWarning = content.includes('usa') || content.includes('vereinigte staaten') || content.includes('drittland');
            
            testResults.thirdCountryWarningsShown = hasUSWarning;
            updateComplianceStatus('check-third-country', hasUSWarning);
            addTestResult(`Drittland-Hinweise: ${hasUSWarning ? '‚úÖ Vorhanden' : '‚ùå Nicht gefunden'}`);
        }

        function checkInformationCompleteness() {
            // Pr√ºfe auf wichtige Informationen im Details-Modal
            const content = document.body.innerText.toLowerCase();
            const hasLegalBasis = content.includes('rechtsgrundlage') || content.includes('legal basis');
            const hasPrivacyInfo = content.includes('datenschutz') || content.includes('privacy');
            const hasRetentionInfo = content.includes('speicherdauer') || content.includes('retention');
            
            const complete = hasLegalBasis && hasPrivacyInfo && hasRetentionInfo;
            updateComplianceStatus('check-information', complete);
            addTestResult(`Informationsvollst√§ndigkeit: ${complete ? '‚úÖ Vollst√§ndig' : '‚ùå Unvollst√§ndig'}`);
        }

        function checkCookieDeletion() {
            // Pr√ºfe ob Cookies tats√§chlich gel√∂scht wurden
            const allCookies = document.cookie;
            const hasTrackingCookies = allCookies.includes('_ga') || allCookies.includes('_fbp') || allCookies.includes('analytics');
            
            // Bei Ablehnung/Widerruf sollten keine Tracking-Cookies vorhanden sein
            const cookiesDeleted = !hasTrackingCookies || allCookies.length === 0;
            testResults.cookiesDeletionVerified = cookiesDeleted;
            updateComplianceStatus('check-cookie-deletion', cookiesDeleted);
            addTestResult(`Cookie-L√∂schung: ${cookiesDeleted ? '‚úÖ Erfolgreich' : '‚ùå Cookies noch vorhanden'}`);
        }

        function updateCookieStatus() {
            const statusElement = document.getElementById('cookieStatus');
            let status = '';
            
            // Cookies
            status += 'üç™ HTTP-Cookies:\n';
            const cookies = document.cookie.split(';');
            if (cookies.length === 1 && cookies[0] === '') {
                status += '  Keine Cookies gesetzt\n\n';
            } else {
                cookies.forEach(cookie => {
                    status += `  ${cookie.trim()}\n`;
                });
                status += '\n';
            }
            
            // LocalStorage
            status += 'üíæ LocalStorage:\n';
            if (localStorage.length === 0) {
                status += '  Leer\n\n';
            } else {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    status += `  ${key}: ${value.substring(0, 100)}${value.length > 100 ? '...' : ''}\n`;
                }
                status += '\n';
            }
            
            // SessionStorage
            status += 'üîÑ SessionStorage:\n';
            if (sessionStorage.length === 0) {
                status += '  Leer\n\n';
            } else {
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    const value = sessionStorage.getItem(key);
                    status += `  ${key}: ${value.substring(0, 100)}${value.length > 100 ? '...' : ''}\n`;
                }
                status += '\n';
            }
            
            // Banner-Status
            status += 'üéØ Banner-Status:\n';
            if (window.dsgvoBanner) {
                status += '  DSGVO-Banner-API: ‚úÖ Verf√ºgbar\n';
                status += `  Funktionen: ${Object.keys(window.dsgvoBanner).join(', ')}\n`;
            } else {
                status += '  DSGVO-Banner-API: ‚ùå Nicht verf√ºgbar\n';
            }
            
            statusElement.textContent = status;
        }

        function clearAllData() {
            // L√∂sche alle Cookies
            document.cookie.split(";").forEach(function(c) {
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
            });
            
            // L√∂sche Storage
            localStorage.clear();
            sessionStorage.clear();
            
            addTestResult('üßπ Alle Cookies und Storage-Daten gel√∂scht');
            setTimeout(updateCookieStatus, 500);
        }

        function simulateNewVisitor() {
            clearAllData();
            setTimeout(() => {
                location.reload();
            }, 1000);
        }

        function updateComplianceStatus(checkId, passed) {
            const element = document.getElementById(checkId);
            if (element) {
                element.className = `compliance-check ${passed ? 'pass' : 'fail'}`;
                element.textContent = passed ? '‚úì' : '‚úó';
            }
        }

        function addTestResult(message) {
            const resultsContainer = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            const resultItem = document.createElement('div');
            resultItem.style.cssText = 'margin: 0.5rem 0; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #007bff;';
            resultItem.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            resultsContainer.insertBefore(resultItem, resultsContainer.firstChild);
            
            // Begrenze die Anzahl der Ergebnisse
            const results = resultsContainer.querySelectorAll('div');
            if (results.length > 20) {
                resultsContainer.removeChild(results[results.length - 1]);
            }
        }

        // Automatische Initialisierung
        document.addEventListener('DOMContentLoaded', function() {
            addTestResult('üìã DSGVO-Compliance-Test-Suite geladen');
            updateCookieStatus();
            
            // Automatische Sichtbarkeitspr√ºfung nach Banner-Load
            setTimeout(() => {
                testBannerVisibility();
                checkEqualVisibility();
            }, 2000);
            
            // Status-Updates alle 5 Sekunden
            setInterval(updateCookieStatus, 5000);
        });

        // Event-Listener f√ºr Banner-Events (falls verf√ºgbar)
        if (window.addEventListener) {
            window.addEventListener('dsgvo-banner-loaded', function() {
                addTestResult('üéØ Banner-Script geladen');
                setTimeout(testBannerVisibility, 500);
            });
            
            window.addEventListener('dsgvo-consent-changed', function(event) {
                addTestResult(`üîÑ Consent ge√§ndert: ${JSON.stringify(event.detail)}`);
                setTimeout(updateCookieStatus, 500);
            });
        }
    </script>
</body>
</html>